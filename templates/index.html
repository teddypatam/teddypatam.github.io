{% extends 'base.html' %}
{% block content %}
<section class="intro">
	<div class="social-icons intro-social">
		{% for network, url in strings.store_links.items() %}
		<a href="{{ url }}" target="_blank" rel="noopener noreferrer" title="{{ network }}">
			<img src="https://www.google.com/s2/favicons?domain={{ url.split('/')[2] }}&sz=32" alt="{{ url }}">
		</a>
		{% endfor %}
	</div>
    <div class="intro-content">
        <div class="intro-icon">
            <img width="48" height="48" src="{{ url_for('static', filename='images/bear.png') }}" alt="bear icon">
        </div>
        <p class="intro-text">{{ strings.intro }}</p>
        <div class="intro-decoration">
			<div class="sparkle sparkle-1" aria-hidden="true">
				<svg class="sparkle-icon" viewBox="0 0 24 24" width="28" height="28" fill="none">
					<path d="M12 2.5l2.1 5.4 5.6.5-4.2 3.6 1.2 5.4L12 15.6 7.3 17.4l1.2-5.4L4.3 8.4l5.6-.5z" fill="currentColor"/>
				</svg>
			</div>
			<div class="sparkle sparkle-2" aria-hidden="true">
				<svg class="sparkle-icon" viewBox="0 0 24 24" width="34" height="34" fill="none">
					<path d="M12 2.5l2.1 5.4 5.6.5-4.2 3.6 1.2 5.4L12 15.6 7.3 17.4l1.2-5.4L4.3 8.4l5.6-.5z" fill="currentColor"/>
				</svg>
			</div>
			<div class="sparkle sparkle-3" aria-hidden="true">
				<svg class="sparkle-icon" viewBox="0 0 24 24" width="24" height="24" fill="none">
					<path d="M12 4.2l1.4 3.3 3.5.4-2.7 2.3.8 3.5L12 11.8 9 13.7l.8-3.5L7.1 7.9l3.5-.4z" fill="currentColor"/>
				</svg>
			</div>
        </div>
    </div>
</section>

{% if groups and groups|length > 0 %}
<section class="filters">
	<div class="filter-row">
		<div class="segmented" role="tablist" aria-label="Filter by group">
			<button class="segmented-btn active" data-filter="all" role="tab" aria-selected="true">{{ strings.all }} ({{
				total_count }})</button>
			<div class="dropdown">
				<button class="segmented-btn" aria-haspopup="true" aria-expanded="false">
					<span class="dropdown-label"> {{ strings.select_group }} </span>
					<svg class="dropdown-arrow" viewBox="0 0 24 24" width="16" height="16">
						<path d="M7 10l5 5 5-5z" fill="currentColor"/>
					</svg>
				</button>
				<div class="segmented-menu">
					{% for g in groups %}
					<button class="segmented-btn menu-item" data-filter="{{ g }}" role="tab" aria-selected="false">{{ g }} ({{
						group_counts.get(g, 0) }})</button>
					{% endfor %}
				</div>
			</div>
		</div>
		<div class="active-filter" style="display: none">
			<span class="filter-text"></span>
			<button class="filter-remove" aria-label="Remove filter">
				<svg viewBox="0 0 24 24" width="14" height="14">
					<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
				</svg>
			</button>
		</div>
	</div>
</section>
{% endif %}

<section class="grid">
	<ul class="card-grid" role="list" id="bear-grid">
		{% for bear in bears %}
		<li class="card" data-group="{{ bear.group if bear.group else '' }}">
			<a class="card-link"
				href="{{ url_for('bear_detail', lang=lang, slug=bear.slug if bear.slug else bear['slug']) }}">
				<div class="card-media">
					{% if bear.pinned %}
					<div class="pin-icon" title="Pinned item">
						<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
							<path d="M16,12V4H17V2H7V4H8V12L6,14V16H11.2V22H12.8V16H18V14L16,12Z" />
						</svg>
					</div>
					{% endif %}
					<img src="{{ url_for('static', filename=bear.cover_image) }}" alt="{{ bear.name }}" loading="lazy">
				</div>
				<div class="card-body">
					<h3 class="card-title">{{ bear.name }}</h3>
					<p class="card-summary">{{ bear.summary }}</p>
				</div>
			</a>
			{% if bear.store_links %}
			<div class="card-footer">
				{% set _links = bear.store_links.items() | list %}
				{% for title, link in _links[:2] %}
				<a href="{{ link }}" class="store-button" target="_blank" rel="noopener">{{ title }}</a>
				{% endfor %}
				{% if _links|length > 2 %}
				<a href="{{ url_for('bear_detail', lang=lang, slug=bear.slug if bear.slug else bear['slug']) }}" class="store-button" aria-label="{{ (_links|length - 2) }} more links">+{{ _links|length - 2 }}</a>
				{% endif %}
			</div>
			{% endif %}
		</li>
		{% endfor %}
	</ul>
</section>

<script>
	(function () {
		var filterRow = document.querySelector('.filter-row');
		if (!filterRow) return;

		var segmented = filterRow.querySelector('.segmented');
		var dropdown = segmented.querySelector('.dropdown');
		var dropdownToggle = dropdown.querySelector('.segmented-btn');
		var dropdownMenu = dropdown.querySelector('.segmented-menu');
		var allButton = segmented.querySelector('.segmented-btn[data-filter="all"]');
		var dropdownItems = Array.prototype.slice.call(dropdownMenu.querySelectorAll('.menu-item'));
		var cards = Array.prototype.slice.call(document.querySelectorAll('#bear-grid .card'));
		var activeFilter = filterRow.querySelector('.active-filter');
		var activeFilterText = activeFilter.querySelector('.filter-text');

		function applyFilter(val) {
			cards.forEach(function (card) {
				var g = card.getAttribute('data-group') || '';
				var show = (val === 'all') || (g === val);
				card.style.display = show ? '' : 'none';
			});
		}

		function updateActiveFilter(text) {
			if (text === 'all') {
				activeFilter.style.display = 'none';
				activeFilterText.textContent = '';
			} else {
				activeFilterText.textContent = text;
				activeFilter.style.display = 'inline-flex';
			}
		}

		// Handle dropdown toggle
		dropdownToggle.addEventListener('click', function(e) {
			var expanded = dropdownToggle.getAttribute('aria-expanded') === 'true';
			dropdownToggle.setAttribute('aria-expanded', !expanded);
			dropdownMenu.style.display = expanded ? 'none' : 'block';
			e.stopPropagation();
		});

		// Close dropdown when clicking outside
		document.addEventListener('click', function() {
			dropdownToggle.setAttribute('aria-expanded', 'false');
			dropdownMenu.style.display = 'none';
		});

		// Handle "All" button click
		allButton.addEventListener('click', function() {
			segmented.querySelectorAll('.segmented-btn').forEach(function(btn) {
				btn.classList.remove('active');
				btn.setAttribute('aria-selected', 'false');
			});
			allButton.classList.add('active');
			allButton.setAttribute('aria-selected', 'true');
			updateActiveFilter('all');
			applyFilter('all');
		});

		// Handle dropdown item clicks
		dropdownItems.forEach(function(item) {
			item.addEventListener('click', function() {
				var filterValue = item.getAttribute('data-filter');
				segmented.querySelectorAll('.segmented-btn').forEach(function(btn) {
					btn.classList.remove('active');
					btn.setAttribute('aria-selected', 'false');
				});
				item.classList.add('active');
				item.setAttribute('aria-selected', 'true');
				updateActiveFilter(item.textContent.trim());
				dropdownToggle.setAttribute('aria-expanded', 'false');
				dropdownMenu.style.display = 'none';
				applyFilter(filterValue);
			});
		});

		// Handle remove filter click
		activeFilter.querySelector('.filter-remove').addEventListener('click', function() {
			allButton.click();
		});
	})();
</script>
{% endblock %}